stages:
  - build
  - release

build:
  stage: build
  image: maven:3.8.1-openjdk-16
  before_script:
    - echo GE_JOB_ID=$CI_JOB_ID >> generate_executables.env
  script: mvn clean package
  artifacts:
    name: "BoxedVillagers"
    paths:
    - "target/*.jar"
    exclude:
      - "target/original*.jar"
    reports:
      dotenv: jar.env

release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script: echo "Creating Release"
  needs:
    - job: build
      artifacts: true
  release:
    name: "Boxed Villagers $CI_COMMIT_SHORT_SHA"
    tag_name: $CI_COMMIT_SHORT_SHA
    description: "Automatically Generated Release"
    assets:
      links:
        - name: Jarfile
          url: "https://gitlab.com/eggmc/boxedvillagers/cw/-/jobs/${GE_JOB_ID}/target/BoxedVillagers-1.0-SNAPSHOT.jar"
  rules:
    - if: $CI_COMMIT_TAG